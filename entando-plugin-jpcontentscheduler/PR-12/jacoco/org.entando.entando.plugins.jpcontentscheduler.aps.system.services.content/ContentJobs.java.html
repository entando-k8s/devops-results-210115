<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ContentJobs.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Entando Plugin: Content Scheduler</a> &gt; <a href="index.source.html" class="el_package">org.entando.entando.plugins.jpcontentscheduler.aps.system.services.content</a> &gt; <span class="el_source">ContentJobs.java</span></div><h1>ContentJobs.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2017-Present Entando Inc. (http://www.entando.com) All rights reserved.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the &quot;Software&quot;), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
package org.entando.entando.plugins.jpcontentscheduler.aps.system.services.content;

import java.util.ArrayList;
import java.util.Collections;
import java.util.Date;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import org.entando.entando.plugins.jpcontentscheduler.aps.system.services.ContentThreadConstants;
import org.entando.entando.plugins.jpcontentscheduler.aps.system.services.content.model.ContentState;
import org.entando.entando.plugins.jpcontentscheduler.aps.system.services.content.model.ContentSuspendMove;
import org.entando.entando.plugins.jpcontentscheduler.aps.system.services.content.util.Utils;
import org.quartz.JobExecutionContext;
import org.quartz.JobExecutionException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.BeansException;
import org.springframework.context.ApplicationContext;
import org.springframework.context.ApplicationContextAware;
import org.springframework.scheduling.quartz.QuartzJobBean;

import com.agiletec.aps.system.ApsSystemUtils;
import com.agiletec.aps.system.common.entity.model.AttributeFieldError;
import com.agiletec.aps.system.common.entity.model.AttributeTracer;
import com.agiletec.aps.system.common.entity.model.attribute.AttributeInterface;
import com.agiletec.aps.system.exception.ApsSystemException;
import com.agiletec.aps.system.services.category.Category;
import com.agiletec.aps.system.services.category.ICategoryManager;
import com.agiletec.aps.system.services.page.IPage;
import com.agiletec.aps.system.services.page.IPageManager;
import com.agiletec.aps.system.services.page.Widget;
import com.agiletec.aps.util.ApsProperties;
import com.agiletec.plugins.jacms.aps.system.services.content.IContentManager;
import com.agiletec.plugins.jacms.aps.system.services.content.model.Content;
import com.agiletec.plugins.jacms.aps.system.services.contentmodel.ContentModel;
import com.agiletec.plugins.jacms.aps.system.services.contentmodel.IContentModelManager;

<span class="fc" id="L60">public class ContentJobs extends QuartzJobBean implements ApplicationContextAware {</span>

<span class="fc" id="L62">	private static final Logger _logger = LoggerFactory.getLogger(ContentJobs.class);</span>

	private static final String APPLICATION_CONTEXT_KEY = &quot;applicationContext&quot;;

	private IContentSchedulerManager _contentSchedulerManager;
	private IContentManager _contentManager;
	private ICategoryManager _categoryManager;
	private IPageManager _pageManager;
	private IContentModelManager _contentModelManager;

	private ApplicationContext _ctx;

	@Override
	public void setApplicationContext(ApplicationContext ac) throws BeansException {
<span class="nc" id="L76">		this._ctx = ac;</span>
<span class="nc" id="L77">	}</span>

	private ApplicationContext getApplicationContext(JobExecutionContext context) throws Exception {
<span class="nc" id="L80">		ApplicationContext appCtx = (ApplicationContext) context.getScheduler().getContext()</span>
<span class="nc" id="L81">				.get(APPLICATION_CONTEXT_KEY);</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">		if (appCtx == null) {</span>
<span class="nc" id="L83">			throw new JobExecutionException(</span>
					ContentThreadConstants.APP_CTX_ERROR + &quot;\&quot;&quot; + APPLICATION_CONTEXT_KEY + &quot;\&quot;&quot;);
		}
<span class="nc" id="L86">		return appCtx;</span>
	}

	private void initBeans(ApplicationContext appCtx) {
<span class="nc" id="L90">		this.setContentSchedulerManager(</span>
<span class="nc" id="L91">				(IContentSchedulerManager) appCtx.getBean(&quot;jpcontentschedulerContentSchedulerManager&quot;));</span>
<span class="nc" id="L92">		this.setContentModelManager((IContentModelManager) appCtx.getBean(&quot;jacmsContentModelManager&quot;));</span>
<span class="nc" id="L93">		this.setCategoryManager((ICategoryManager) appCtx.getBean(&quot;CategoryManager&quot;));</span>
<span class="nc" id="L94">		this.setPageManager((IPageManager) appCtx.getBean(&quot;PageManager&quot;));</span>
<span class="nc" id="L95">	}</span>

	@Override
	protected void executeInternal(JobExecutionContext context) throws JobExecutionException {
		try {
<span class="nc" id="L100">			ApplicationContext appCtx = getApplicationContext(context);</span>
<span class="nc" id="L101">			this.initBeans(appCtx);</span>
<span class="nc" id="L102">			this.executeJob(appCtx);</span>
<span class="nc" id="L103">		} catch (Exception ex) {</span>
<span class="nc" id="L104">			_logger.error(&quot;error in executeInternal&quot;, ex);</span>
<span class="nc" id="L105">			throw new RuntimeException(&quot;Errore in inserimento/sospensione contenuti online&quot;, ex);</span>
<span class="nc" id="L106">		}</span>
<span class="nc" id="L107">	}</span>

	public void executeJob(ApplicationContext appCtx) throws JobExecutionException {
		try {
<span class="fc" id="L111">			if (this.getContentSchedulerManager().getConfig()</span>
<span class="pc bpc" id="L112" title="1 of 2 branches missed.">					.isActive()/* &amp;&amp; isCurrentSiteAllowed() */) {</span>
<span class="fc" id="L113">				Date startJobDate = new Date();</span>
<span class="fc" id="L114">				_logger.info(ContentThreadConstants.START_TIME_LOG + Utils.printTimeStamp(startJobDate));</span>
<span class="fc" id="L115">				List&lt;ContentState&gt; removedContents = new ArrayList&lt;ContentState&gt;();</span>
<span class="fc" id="L116">				List&lt;ContentState&gt; publishedContents = new ArrayList&lt;ContentState&gt;();</span>
<span class="fc" id="L117">				List&lt;ContentState&gt; moveContents = new ArrayList&lt;ContentState&gt;();</span>
				try {
<span class="fc" id="L119">					this.publishContentsJob(publishedContents);</span>
					// System.out.println(&quot;CONTENUTI DA PUBLICARE -&gt; &quot; +
					// publishedContents);
<span class="fc" id="L122">					this.suspendOrMoveContentsJob(removedContents, moveContents, appCtx);</span>
					try {
<span class="fc" id="L124">						Collections.sort(publishedContents);</span>
<span class="fc" id="L125">						Collections.sort(removedContents);</span>
<span class="fc" id="L126">						Collections.sort(moveContents);</span>
<span class="fc" id="L127">						Date endJobDate = new Date();</span>
<span class="fc" id="L128">						_logger.info(ContentThreadConstants.END_TIME_LOG + Utils.printTimeStamp(endJobDate));</span>
<span class="fc" id="L129">						this.getContentSchedulerManager().sendMailWithResults(publishedContents, removedContents,</span>
								moveContents, startJobDate, endJobDate);
<span class="nc" id="L131">					} catch (Throwable t) {</span>
<span class="nc" id="L132">						throw new ApsSystemException(ContentThreadConstants.ERROR_ON_MAIL, t);</span>
<span class="fc" id="L133">					}</span>
<span class="nc" id="L134">				} catch (Throwable t) {</span>
<span class="nc" id="L135">					ApsSystemUtils.logThrowable(t, this, t.getMessage());</span>
<span class="nc" id="L136">					throw new RuntimeException(&quot;Errore in inserimento/sospensione contenuti online&quot;, t);</span>
<span class="fc" id="L137">				}</span>
			}
<span class="nc" id="L139">		} catch (Throwable t) {</span>
<span class="nc" id="L140">			ApsSystemUtils.logThrowable(t, this, t.getMessage());</span>
<span class="nc" id="L141">			throw new RuntimeException(&quot;Errore inizializzazione spring bean: &quot;, t);</span>
<span class="fc" id="L142">		}</span>
<span class="fc" id="L143">	}</span>

	private void publishContentsJob(List&lt;ContentState&gt; publishedContents) throws ApsSystemException {
		try {
			// Restituisce gli id dei contenuti che hanno un attributo con nome
			// key Data_inizio e valore la data corrente
<span class="fc" id="L149">			List&lt;String&gt; contentIds = this.getContentSchedulerManager().getContentIdToPublish();</span>
			// System.out.println(&quot;CONTENUTI DA PUBLICARE ESTRATTI -&gt; &quot; +
			// contentIds);
<span class="fc" id="L152">			Iterator&lt;String&gt; iter = contentIds.iterator();</span>
			// Cicla di contenuti da pubblicare in data odierna
<span class="pc bpc" id="L154" title="1 of 2 branches missed.">			while (iter.hasNext()) {</span>
<span class="nc" id="L155">				String contentId = null;</span>
				try {
<span class="nc" id="L157">					contentId = (String) iter.next();</span>
<span class="nc" id="L158">					Content contentToPublish = this.getContentManager().loadContent(contentId, false);</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">					if (null == contentToPublish) {</span>
<span class="nc" id="L160">						publishedContents.add(new ContentState(contentId, &quot;null&quot;, &quot;null&quot;,</span>
								ContentThreadConstants.PUBLISH_ACTION, ContentThreadConstants.NULL_CONTENT));
<span class="nc" id="L162">						_logger.info(&quot;Pubblicazione automatica non riuscita: &quot; + contentId + &quot; - &quot;</span>
								+ ContentThreadConstants.NULL_CONTENT);
<span class="nc" id="L164">						continue;</span>
					}
<span class="nc bnc" id="L166" title="All 2 branches missed.">					if (contentToPublish.isOnLine()) {</span>
<span class="nc" id="L167">						publishedContents.add(new ContentState(contentToPublish.getId(), contentToPublish.getTypeCode(),</span>
<span class="nc" id="L168">								contentToPublish.getDescription(), ContentThreadConstants.PUBLISH_ACTION,</span>
								ContentThreadConstants.ISALREADYONLINE));
<span class="nc" id="L170">						_logger.info(&quot;Pubblicazione automatica non riuscita: &quot; + contentToPublish.getId() + &quot; - &quot;</span>
								+ ContentThreadConstants.ISALREADYONLINE);
<span class="nc" id="L172">						continue;</span>
					}
<span class="nc bnc" id="L174" title="All 2 branches missed.">					if (!Content.STATUS_READY.equals(contentToPublish.getStatus())) {</span>
<span class="nc" id="L175">						publishedContents.add(new ContentState(contentToPublish.getId(), contentToPublish.getTypeCode(),</span>
<span class="nc" id="L176">								contentToPublish.getDescription(), ContentThreadConstants.PUBLISH_ACTION,</span>
								ContentThreadConstants.NOTREADYSTATUS));
<span class="nc" id="L178">						_logger.info(&quot;Pubblicazione automatica non riuscita: &quot; + contentToPublish.getId() + &quot; - &quot;</span>
								+ ContentThreadConstants.NOTREADYSTATUS);
<span class="nc" id="L180">						continue;</span>
					}
<span class="nc" id="L182">					boolean validation = this.scanEntity(contentToPublish);</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">					if (!validation) {</span>
<span class="nc" id="L184">						publishedContents.add(new ContentState(contentToPublish.getId(), contentToPublish.getTypeCode(),</span>
<span class="nc" id="L185">								contentToPublish.getDescription(), ContentThreadConstants.PUBLISH_ACTION,</span>
								ContentThreadConstants.CONTENTWITHERRORS));
<span class="nc" id="L187">						_logger.info(&quot;Pubblicazione automatica non riuscita: &quot; + contentToPublish.getId() + &quot; - &quot;</span>
								+ ContentThreadConstants.CONTENTWITHERRORS);
<span class="nc" id="L189">						continue;</span>
					}
					// pubblicazione on line del contenuto e modifica data di
					// ultima modifica
<span class="nc" id="L193">					this.getContentManager().insertOnLineContent(contentToPublish);</span>
<span class="nc" id="L194">					_logger.info(&quot;Pubblicato automaticamente contenuto &quot; + contentToPublish.getId());</span>
<span class="nc" id="L195">					publishedContents.add(new ContentState(contentToPublish.getId(), contentToPublish.getTypeCode(),</span>
<span class="nc" id="L196">							contentToPublish.getDescription(), ContentThreadConstants.PUBLISH_ACTION,</span>
							ContentThreadConstants.ACTION_SUCCESS));
<span class="nc" id="L198">				} catch (Throwable t) {</span>
<span class="nc" id="L199">					ApsSystemUtils.logThrowable(t, this, ContentThreadConstants.UNEXPECTED_ERROR);</span>
<span class="nc" id="L200">					publishedContents.add(new ContentState(contentId, &quot;null&quot;, &quot;null&quot;,</span>
<span class="nc" id="L201">							ContentThreadConstants.PUBLISH_ACTION, t.getMessage()));</span>
<span class="nc" id="L202">				}</span>
<span class="nc" id="L203">			}</span>
<span class="nc" id="L204">		} catch (Throwable t) {</span>
<span class="nc" id="L205">			throw new ApsSystemException(ContentThreadConstants.ERROR_ON_PUBLISH, t);</span>
<span class="fc" id="L206">		}</span>
<span class="fc" id="L207">	}</span>

	public boolean scanEntity(Content currentContent) {
		try {
<span class="nc" id="L211">			List&lt;AttributeInterface&gt; attributes = currentContent.getAttributeList();</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">			for (int i = 0; i &lt; attributes.size(); i++) {</span>
<span class="nc" id="L213">				AttributeInterface entityAttribute = attributes.get(i);</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">				if (entityAttribute.isActive()) {</span>
<span class="nc" id="L215">					List&lt;AttributeFieldError&gt; errors = entityAttribute.validate(new AttributeTracer());</span>
<span class="nc bnc" id="L216" title="All 4 branches missed.">					if (null != errors &amp;&amp; errors.size() &gt; 0) {</span>
<span class="nc" id="L217">						return false;</span>
					}
				}
			}
<span class="nc" id="L221">		} catch (Throwable t) {</span>
<span class="nc" id="L222">			_logger.error(&quot;Error scanning Entity&quot;, t);</span>
<span class="nc" id="L223">			throw new RuntimeException(&quot;Error scanning Entity&quot;, t);</span>
<span class="nc" id="L224">		}</span>
<span class="nc" id="L225">		return true;</span>
	}

	@SuppressWarnings(&quot;unchecked&quot;)
	private void suspendOrMoveContentsJob(List&lt;ContentState&gt; removedContents, List&lt;ContentState&gt; moveContents,
			ApplicationContext appCtx) throws ApsSystemException {
		try {
			// Restituisce gli id dei contenuti che hanno un attributo con nome
			// key Data_fine e valore la data corrente
<span class="fc" id="L234">			List&lt;ContentSuspendMove&gt; content = this.getContentSchedulerManager().getContentAttrDataFine();</span>
			// Cicla per tipo di contenuto
<span class="fc bfc" id="L236" title="All 2 branches covered.">			for (ContentSuspendMove c : content) {</span>
<span class="fc" id="L237">				List&lt;String&gt; contentIds = c.getIdsContents();</span>
				// se suspend = true si effettua la depubblicazione
<span class="pc bpc" id="L239" title="2 of 4 branches missed.">				if (c.getSuspend() != null &amp;&amp; c.getSuspend().equalsIgnoreCase(&quot;true&quot;)) {</span>
<span class="fc" id="L240">					Iterator&lt;String&gt; iter = contentIds.iterator();</span>
<span class="pc bpc" id="L241" title="1 of 2 branches missed.">					while (iter.hasNext()) {</span>
<span class="nc" id="L242">						String contentId = null;</span>
						try {
<span class="nc" id="L244">							contentId = (String) iter.next();</span>
<span class="nc" id="L245">							Content contentToSuspend = this.getContentManager().loadContent(contentId, false);</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">							if (null == contentToSuspend) {</span>
<span class="nc" id="L247">								removedContents.add(new ContentState(contentId, &quot;null&quot;, &quot;null&quot;,</span>
										ContentThreadConstants.SUSPEND_ACTION, ContentThreadConstants.NULL_CONTENT));
<span class="nc" id="L249">								ApsSystemUtils.getLogger().info(&quot;Sospensione automatica non riuscita: &quot; + contentId</span>
										+ &quot; - &quot; + ContentThreadConstants.NULL_CONTENT);
<span class="nc" id="L251">								continue;</span>
							}
<span class="nc bnc" id="L253" title="All 2 branches missed.">							if (!contentToSuspend.isOnLine()) {</span>
<span class="nc" id="L254">								removedContents.add(new ContentState(contentToSuspend.getId(),</span>
<span class="nc" id="L255">										contentToSuspend.getTypeCode(), contentToSuspend.getDescription(),</span>
										ContentThreadConstants.SUSPEND_ACTION,
										ContentThreadConstants.ISALREADYSUSPENDED));
<span class="nc" id="L258">								ApsSystemUtils.getLogger().info(&quot;Sospensione automatica non riuscita: &quot;</span>
<span class="nc" id="L259">										+ contentToSuspend.getId() + &quot; - &quot; + ContentThreadConstants.ISALREADYSUSPENDED);</span>
<span class="nc" id="L260">								continue;</span>
							}
							// controllo se il contenuto è correlato a delle
							// pagine
<span class="nc" id="L264">							Map&lt;String, List&gt; references = Utils.getReferencingObjects(contentToSuspend, appCtx);</span>
<span class="nc" id="L265">							String operation = &quot;suspend&quot;;</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">							if (references.size() &gt; 0) {</span>
								// se i vincoli sono la presenza del contenuto
								// nelle pagine.
<span class="nc" id="L269">								List&lt;IPage&gt; listaPagine = references.get(&quot;CmsPageManagerWrapperUtilizers&quot;);</span>
<span class="nc bnc" id="L270" title="All 4 branches missed.">								if (listaPagine != null &amp;&amp; listaPagine.size() &gt; 0) {</span>
<span class="nc" id="L271">									String contentIdOfContentToPublish = c.getFieldNameContentReplace();</span>
<span class="nc" id="L272">									String contenutoSostitutivo = null;</span>
<span class="nc bnc" id="L273" title="All 4 branches missed.">									if (contentIdOfContentToPublish != null &amp;&amp; !contentIdOfContentToPublish.isEmpty()) {</span>
<span class="nc" id="L274">                                                                                contenutoSostitutivo = contentIdOfContentToPublish;</span>
									}
<span class="nc" id="L276">									String contentModelIdOfContentToPublish = c.getFieldNameModelContentReplace();</span>
<span class="nc" id="L277">									String modelContenutoSostitutivo = null;</span>
<span class="nc bnc" id="L278" title="All 4 branches missed.">									if (contentModelIdOfContentToPublish != null &amp;&amp; !contentModelIdOfContentToPublish.isEmpty()) {</span>
<span class="nc" id="L279">                                                                            modelContenutoSostitutivo = contentModelIdOfContentToPublish;</span>
									}
									// Contenuto sostitutivo impostato nel caso
									// in cui non sia presente il campo per il
									// contenuto sostitutivo
<span class="nc" id="L284">									String contSostIdRepl = c.getContentIdReplace();</span>
<span class="nc" id="L285">									String contSostModelRepl = c.getContentModelReplace();</span>
<span class="nc bnc" id="L286" title="All 4 branches missed.">									if (contenutoSostitutivo == null || contenutoSostitutivo.isEmpty()) {</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">										if (contSostIdRepl != null) {</span>
<span class="nc" id="L288">											contenutoSostitutivo = contSostIdRepl;</span>
<span class="nc" id="L289">											modelContenutoSostitutivo = contSostModelRepl;</span>
										} else {
<span class="nc" id="L291">											ApsSystemUtils.getLogger().info(</span>
													&quot;Errore nella Sospensione/Spostamento dei contenuti, manca l'attributo 'contentReplace' nella configurazione del plugin&quot;);
										}
									}
<span class="nc bnc" id="L295" title="All 4 branches missed.">									if (contenutoSostitutivo != null &amp;&amp; !contenutoSostitutivo.isEmpty()) {</span>
										// Controlli sul contenuto sostitutivo
<span class="nc" id="L297">										Content contentToReplace = this.getContentManager()</span>
<span class="nc" id="L298">												.loadContent(contenutoSostitutivo, false);</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">										if (null == contentToReplace) {</span>
<span class="nc" id="L300">											removedContents.add(new ContentState(contentToSuspend.getId(),</span>
<span class="nc" id="L301">													contentToSuspend.getTypeCode(), contentToSuspend.getDescription(),</span>
													ContentThreadConstants.SUSPEND_ACTION,
													ContentThreadConstants.NULL_CONTENT_REPLACE));
<span class="nc" id="L304">											ApsSystemUtils.getLogger()</span>
<span class="nc" id="L305">													.info(&quot;Sospensione automatica non riuscita: &quot;</span>
<span class="nc" id="L306">															+ contentToSuspend.getId() + &quot; - &quot;</span>
															+ ContentThreadConstants.NULL_CONTENT_REPLACE);
<span class="nc" id="L308">											continue;</span>
										}
<span class="nc bnc" id="L310" title="All 2 branches missed.">										if (!contentToReplace.isOnLine()) {</span>
<span class="nc" id="L311">											removedContents.add(new ContentState(contentToSuspend.getId(),</span>
<span class="nc" id="L312">													contentToSuspend.getTypeCode(), contentToSuspend.getDescription(),</span>
													ContentThreadConstants.SUSPEND_ACTION,
													ContentThreadConstants.ISNOTONLINE));
<span class="nc" id="L315">											ApsSystemUtils.getLogger()</span>
<span class="nc" id="L316">													.info(&quot;Sospensione automatica non riuscita: &quot;</span>
<span class="nc" id="L317">															+ contentToSuspend.getId() + &quot; - &quot;</span>
															+ ContentThreadConstants.ISNOTONLINE);
<span class="nc" id="L319">											continue;</span>
										}
<span class="nc" id="L321">										boolean contentModelExist = false;</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">										if (modelContenutoSostitutivo != null) {</span>
<span class="nc" id="L323">											List&lt;ContentModel&gt; listcontentModel = this.getContentModelManager()</span>
<span class="nc" id="L324">													.getModelsForContentType(contentToReplace.getTypeCode());</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">											for (ContentModel contMod : listcontentModel) {</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">												if (String.valueOf(contMod.getId()).equals(modelContenutoSostitutivo)) {</span>
<span class="nc" id="L327">													contentModelExist = true;</span>
<span class="nc" id="L328">													break;</span>
												}
<span class="nc" id="L330">											}</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">											if (!contentModelExist) {</span>
<span class="nc" id="L332">												modelContenutoSostitutivo = contentToReplace.getDefaultModel();</span>
											}
										}

										// Trova l'elenco delle pagine in cui il
										// contenuto è settato
<span class="nc bnc" id="L338" title="All 2 branches missed.">										for (IPage page : listaPagine) {</span>
<span class="nc" id="L339">											int framePos = -1;</span>
<span class="nc" id="L340">											Widget widget = null;</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">											for (int i = 0; i &lt; page.getWidgets().length; i++) {</span>
<span class="nc" id="L342">												Widget w = page.getWidgets()[i];</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">												if (w != null) {</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">													if (w.getConfig() != null) {</span>
<span class="nc" id="L345">														ApsProperties prop = w.getConfig();</span>
<span class="nc" id="L346">														String codeContentPage = prop.getProperty(&quot;contentId&quot;);</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">														if (codeContentPage != null &amp;&amp; codeContentPage</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">																.equalsIgnoreCase(contentToSuspend.getId())) {</span>
															// trova il widget
															// ed il framepos,
															// poi setta il
															// contenuto
															// sotitutivo
<span class="nc" id="L354">															ApsProperties propconfig = new ApsProperties();</span>
<span class="nc" id="L355">															propconfig.setProperty(&quot;contentId&quot;, contenutoSostitutivo);</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">															if (modelContenutoSostitutivo != null) {</span>
<span class="nc" id="L357">																propconfig.setProperty(&quot;modelId&quot;,</span>
																		modelContenutoSostitutivo);
															}
<span class="nc" id="L360">															w.setConfig(propconfig);</span>
<span class="nc" id="L361">															framePos = i;</span>
<span class="nc" id="L362">															widget = w;</span>
<span class="nc" id="L363">															break;</span>
														}
													}
												}
											} // fine ciclo dei widget
<span class="nc bnc" id="L368" title="All 4 branches missed.">											if (framePos != -1 &amp;&amp; widget != null) {</span>
<span class="nc" id="L369">												this.getPageManager().joinWidget(page.getCode(), widget, framePos);</span>
<span class="nc" id="L370">                                                                                                this.getPageManager().setPageOnline(page.getCode());</span>
<span class="nc" id="L371">												operation = &quot;replaceContent&quot;;</span>
											}
<span class="nc" id="L373">										}</span>
<span class="nc" id="L374">									} else {</span>
<span class="nc" id="L375">										removedContents.add(new ContentState(contentToSuspend.getId(),</span>
<span class="nc" id="L376">												contentToSuspend.getTypeCode(), contentToSuspend.getDescription(),</span>
												ContentThreadConstants.SUSPEND_ACTION,
												ContentThreadConstants.CONTENT_WITH_REFERENCES));
<span class="nc" id="L379">										ApsSystemUtils.getLogger()</span>
<span class="nc" id="L380">												.info(&quot;Sospensione automatica non riuscita: &quot; + contentToSuspend.getId()</span>
														+ &quot; - &quot; + ContentThreadConstants.CONTENT_WITH_REFERENCES);
<span class="nc" id="L382">										continue;</span>
									}
<span class="nc" id="L384">								} else {</span>
									// se i vincoli non sono pagine --&gt;
									// verificare abilitazione controllo sui
									// link
<span class="nc" id="L388">									String controlLink = this.getContentSchedulerManager()</span>
<span class="nc" id="L389">											.getSystemParam(&quot;referencesUnlink&quot;);</span>
<span class="nc" id="L390">									boolean controlActive = false;</span>
<span class="nc bnc" id="L391" title="All 4 branches missed.">									if (controlLink == null || controlLink.isEmpty()) {</span>
										// se il campo non è esistente metto a
										// true cosi non avviene la
										// depubblicazione
<span class="nc" id="L395">										controlActive = true;</span>
									}
<span class="nc bnc" id="L397" title="All 4 branches missed.">									if (controlLink != null &amp;&amp; controlLink.equalsIgnoreCase(&quot;enabled&quot;)) {</span>
<span class="nc" id="L398">										controlActive = true;</span>
									}
<span class="nc bnc" id="L400" title="All 2 branches missed.">									if (controlActive) {</span>
										// controllo sui link abilitato, non
										// avviene la depubblicazione
<span class="nc" id="L403">										removedContents.add(new ContentState(contentToSuspend.getId(),</span>
<span class="nc" id="L404">												contentToSuspend.getTypeCode(), contentToSuspend.getDescription(),</span>
												ContentThreadConstants.SUSPEND_ACTION,
												ContentThreadConstants.CONTENT_WITH_REFERENCE_CONTENT));
<span class="nc" id="L407">										ApsSystemUtils.getLogger()</span>
<span class="nc" id="L408">												.info(&quot;Sospensione automatica non riuscita: &quot; + contentToSuspend.getId()</span>
														+ &quot; - &quot; + ContentThreadConstants.CONTENT_WITH_REFERENCE_CONTENT);
<span class="nc" id="L410">										continue;</span>
									} else {
										// controllo sui link non abilitato si
										// depubblica comunque, mettendo in
										// evidenza nella mail la
										// presenza di possibili link rotti
										// List&lt;Content&gt; listaContenutiRef =
										// references.get(&quot;jacmsContentManagerUtilizers&quot;);
<span class="nc" id="L418">										operation = &quot;controlDisabled&quot;;</span>
									}
								}
							} // fine if contenuti con referenze

							// Aggiungo la categoria globale, se non sono state
							// precisate categorie assegnate al tipo di
							// contenuto
<span class="nc" id="L426">							Category catGlobal = null;</span>
<span class="nc bnc" id="L427" title="All 2 branches missed.">							if (c.getGlobalCat() != null) {</span>
<span class="nc" id="L428">								catGlobal = this.getCategoryManager().getCategory(c.getGlobalCat());</span>
							} else {
								// senza categoria globale non posso effettuare
								// lo spostamento o la depubblicazione
<span class="nc" id="L432">								ApsSystemUtils.getLogger().info(</span>
										&quot;Errore nella Sospensione/Spostamento dei contenuti, manca l'attributo 'globalcat' nella configurazione del plugin&quot;);
<span class="nc" id="L434">								continue;</span>
							}

<span class="nc bnc" id="L437" title="All 4 branches missed.">							if (c.getCatType() != null &amp;&amp; c.getCatType().size() &gt; 0) {</span>
<span class="nc bnc" id="L438" title="All 2 branches missed.">								for (String code : c.getCatType()) {</span>
<span class="nc" id="L439">									Category cat = this.getCategoryManager().getCategory(code);</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">									if (!contentToSuspend.getCategories().contains(cat)) {</span>
<span class="nc" id="L441">										contentToSuspend.addCategory(cat);</span>
									}
<span class="nc" id="L443">								}</span>
							} else {
<span class="nc bnc" id="L445" title="All 2 branches missed.">								if (catGlobal == null) {</span>
<span class="nc" id="L446">									ApsSystemUtils.getLogger().info(</span>
											&quot;Errore nella Sospensione/Spostamento dei contenuti, l'attributo 'globalcat' non corrisponde ad alcuna categoria esistente&quot;);
<span class="nc" id="L448">									continue;</span>
								}
<span class="nc bnc" id="L450" title="All 2 branches missed.">								if (!contentToSuspend.getCategories().contains(catGlobal)) {</span>
<span class="nc" id="L451">									contentToSuspend.addCategory(catGlobal);</span>
								}
							}
							// Sospendi contenuto = non più visibile online e
							// non viene cambiata la data di ultima modifica
<span class="nc" id="L456">							this.getContentSchedulerManager().removeOnLineContent(contentToSuspend, false);</span>
<span class="nc bnc" id="L457" title="All 2 branches missed.">							if (operation.equals(&quot;suspend&quot;)) {</span>
<span class="nc" id="L458">								ApsSystemUtils.getLogger()</span>
<span class="nc" id="L459">										.info(&quot;Sospeso automaticamente contenuto &quot; + contentToSuspend.getId());</span>
<span class="nc" id="L460">								removedContents.add(new ContentState(contentToSuspend.getId(),</span>
<span class="nc" id="L461">										contentToSuspend.getTypeCode(), contentToSuspend.getDescription(),</span>
										ContentThreadConstants.SUSPEND_ACTION, ContentThreadConstants.ACTION_SUCCESS));
<span class="nc bnc" id="L463" title="All 2 branches missed.">							} else if (operation.equals(&quot;replaceContent&quot;)) {</span>
<span class="nc" id="L464">								ApsSystemUtils.getLogger()</span>
<span class="nc" id="L465">										.info(&quot;Sospeso automaticamente contenuto &quot; + contentToSuspend.getId());</span>
<span class="nc" id="L466">								removedContents.add(new ContentState(contentToSuspend.getId(),</span>
<span class="nc" id="L467">										contentToSuspend.getTypeCode(),</span>
<span class="nc" id="L468">										contentToSuspend.getDescription() + &quot; - &quot;</span>
												+ ContentThreadConstants.REPLACE_CONTENT,
										ContentThreadConstants.SUSPEND_ACTION, ContentThreadConstants.ACTION_SUCCESS));
<span class="nc bnc" id="L471" title="All 2 branches missed.">							} else if (operation.equals(&quot;controlDisabled&quot;)) {</span>
<span class="nc" id="L472">								removedContents.add(new ContentState(contentToSuspend.getId(),</span>
<span class="nc" id="L473">										contentToSuspend.getTypeCode(),</span>
<span class="nc" id="L474">										contentToSuspend.getDescription() + &quot; - &quot;</span>
												+ ContentThreadConstants.CONTENT_WITH_REFERENCES_AND_BROKEN_LINK,
										ContentThreadConstants.SUSPEND_ACTION, ContentThreadConstants.ACTION_SUCCESS));
<span class="nc" id="L477">								ApsSystemUtils.getLogger()</span>
<span class="nc" id="L478">										.info(&quot;Sospensione automatica riuscita: &quot; + contentToSuspend.getId() + &quot; - &quot;</span>
												+ ContentThreadConstants.CONTENT_WITH_REFERENCES_AND_BROKEN_LINK);
							}
<span class="nc" id="L481">						} catch (Throwable t) {</span>
<span class="nc" id="L482">							ApsSystemUtils.logThrowable(t, this, ContentThreadConstants.UNEXPECTED_ERROR);</span>
<span class="nc" id="L483">							removedContents.add(new ContentState(contentId, &quot;null&quot;, &quot;null&quot;,</span>
<span class="nc" id="L484">									ContentThreadConstants.SUSPEND_ACTION, t.getMessage()));</span>
<span class="nc" id="L485">						}</span>
<span class="nc" id="L486">					} // chiusura while</span>
<span class="pc bnc" id="L487" title="All 4 branches missed.">				} else if (c.getSuspend() != null &amp;&amp; c.getSuspend().equalsIgnoreCase(&quot;false&quot;)) { // SPOSTA</span>
																									// IN
																									// ARCHIVIO
					// se suspend = false si effettua lo spostamento del
					// contenuto in archivio senza depubblicare
<span class="nc" id="L492">					Iterator&lt;String&gt; iter = contentIds.iterator();</span>
<span class="nc bnc" id="L493" title="All 2 branches missed.">					while (iter.hasNext()) {</span>
<span class="nc" id="L494">						String contentId = null;</span>
						try {
<span class="nc" id="L496">							contentId = (String) iter.next();</span>
<span class="nc" id="L497">							Content contentToMove = this.getContentManager().loadContent(contentId, false);</span>
<span class="nc bnc" id="L498" title="All 2 branches missed.">							if (null == contentToMove) {</span>
<span class="nc" id="L499">								moveContents.add(new ContentState(contentId, &quot;null&quot;, &quot;null&quot;,</span>
										ContentThreadConstants.MOVE_ACTION, ContentThreadConstants.NULL_CONTENT));
<span class="nc" id="L501">								ApsSystemUtils.getLogger().info(&quot;Spostamento automatico in archivio non riuscito: &quot;</span>
										+ contentId + &quot; - &quot; + ContentThreadConstants.NULL_CONTENT);
<span class="nc" id="L503">								continue;</span>
							}
<span class="nc bnc" id="L505" title="All 2 branches missed.">							if (!contentToMove.isOnLine()) {</span>
<span class="nc" id="L506">								moveContents.add(new ContentState(contentToMove.getId(), contentToMove.getTypeCode(),</span>
<span class="nc" id="L507">										contentToMove.getDescription(), ContentThreadConstants.MOVE_ACTION,</span>
										ContentThreadConstants.ISALREADYSUSPENDED));
<span class="nc" id="L509">								ApsSystemUtils.getLogger().info(&quot;Spostamento automatico in archivio non riuscito: &quot;</span>
<span class="nc" id="L510">										+ contentToMove.getId() + &quot; - &quot; + ContentThreadConstants.ISALREADYSUSPENDED);</span>
<span class="nc" id="L511">								continue;</span>
							}
<span class="nc" id="L513">							boolean alreadyMove = false;</span>
<span class="nc" id="L514">							String operation = &quot;move&quot;;</span>
<span class="nc" id="L515">							Map&lt;String, List&gt; references = Utils.getReferencingObjects(contentToMove, appCtx);</span>
<span class="nc bnc" id="L516" title="All 2 branches missed.">							if (references.size() &gt; 0) {</span>
								// Trovati dei vincoli con il contenuto da
								// spostare
								// Trova l'elenco delle pagine in cui il
								// contenuto è settato
<span class="nc" id="L521">								List&lt;IPage&gt; listaPagine = references.get(&quot;PageManagerUtilizers&quot;);</span>
<span class="nc bnc" id="L522" title="All 4 branches missed.">								if (listaPagine != null &amp;&amp; listaPagine.size() &gt; 0) {</span>
<span class="nc" id="L523">									String contentIdOfContentToPublish = c.getFieldNameContentReplace();</span>
<span class="nc" id="L524">									String contenutoSostitutivo = null;</span>
<span class="nc bnc" id="L525" title="All 4 branches missed.">									if (contentIdOfContentToPublish != null &amp;&amp; !contentIdOfContentToPublish.isEmpty()) {</span>
<span class="nc" id="L526">                                                                                contenutoSostitutivo = contentIdOfContentToPublish;</span>
									}
<span class="nc" id="L528">									String contentModelIdOfContentToPublish = c.getFieldNameModelContentReplace();</span>
<span class="nc" id="L529">									String modelContenutoSostitutivo = null;</span>
<span class="nc bnc" id="L530" title="All 4 branches missed.">									if (contentModelIdOfContentToPublish != null &amp;&amp; !contentModelIdOfContentToPublish.isEmpty()) {</span>
<span class="nc" id="L531">                                                                            modelContenutoSostitutivo = contentModelIdOfContentToPublish;</span>
									}
									// Contenuto sostitutivo impostato nel caso
									// in cui non sia presente il campo per il
									// contenuto sostitutivo
<span class="nc" id="L536">									String contSostIdRepl = c.getContentIdReplace();</span>
<span class="nc" id="L537">									String contSostModelRepl = c.getContentModelReplace();</span>
<span class="nc bnc" id="L538" title="All 4 branches missed.">									if (contenutoSostitutivo == null || contenutoSostitutivo.isEmpty()) {</span>
<span class="nc bnc" id="L539" title="All 2 branches missed.">										if (contSostIdRepl != null) {</span>
<span class="nc" id="L540">											contenutoSostitutivo = contSostIdRepl;</span>
<span class="nc" id="L541">											modelContenutoSostitutivo = contSostModelRepl;</span>
										} else {
<span class="nc" id="L543">											ApsSystemUtils.getLogger().info(</span>
													&quot;Errore nella Sospensione/Spostamento dei contenuti, manca l'attributo 'contentReplace' nella configurazione del plugin&quot;);
										}
									}
<span class="nc bnc" id="L547" title="All 4 branches missed.">									if (contenutoSostitutivo != null &amp;&amp; !contenutoSostitutivo.isEmpty()) {</span>
										// Controlli sulla correttezza del
										// contenuto sostitutivo
<span class="nc" id="L550">										Content contentToReplace = this.getContentManager()</span>
<span class="nc" id="L551">												.loadContent(contenutoSostitutivo, false);</span>
<span class="nc bnc" id="L552" title="All 2 branches missed.">										if (null == contentToReplace) {</span>
<span class="nc" id="L553">											moveContents.add(new ContentState(contentToMove.getId(),</span>
<span class="nc" id="L554">													contentToMove.getTypeCode(), contentToMove.getDescription(),</span>
													ContentThreadConstants.SUSPEND_ACTION,
													ContentThreadConstants.NULL_CONTENT_REPLACE));
<span class="nc" id="L557">											ApsSystemUtils.getLogger()</span>
<span class="nc" id="L558">													.info(&quot;Spostamento automatico in archivio: &quot; + contentToMove.getId()</span>
															+ &quot; - &quot; + ContentThreadConstants.NULL_CONTENT_REPLACE);
<span class="nc" id="L560">											continue;</span>
										}
<span class="nc bnc" id="L562" title="All 2 branches missed.">										if (!contentToReplace.isOnLine()) {</span>
<span class="nc" id="L563">											moveContents.add(new ContentState(contentToMove.getId(),</span>
<span class="nc" id="L564">													contentToMove.getTypeCode(), contentToMove.getDescription(),</span>
													ContentThreadConstants.SUSPEND_ACTION,
													ContentThreadConstants.ISNOTONLINE));
<span class="nc" id="L567">											ApsSystemUtils.getLogger()</span>
<span class="nc" id="L568">													.info(&quot;Spostamento automatico in archivio: &quot; + contentToMove.getId()</span>
															+ &quot; - &quot; + ContentThreadConstants.ISNOTONLINE);
<span class="nc" id="L570">											continue;</span>
										}
<span class="nc" id="L572">										boolean contentModelExist = false;</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">										if (modelContenutoSostitutivo != null) {</span>
<span class="nc" id="L574">											List&lt;ContentModel&gt; listcontentModel = this.getContentModelManager()</span>
<span class="nc" id="L575">													.getModelsForContentType(contentToReplace.getTypeCode());</span>
<span class="nc bnc" id="L576" title="All 2 branches missed.">											for (ContentModel contMod : listcontentModel) {</span>
<span class="nc bnc" id="L577" title="All 2 branches missed.">												if (String.valueOf(contMod.getId()).equals(modelContenutoSostitutivo)) {</span>
<span class="nc" id="L578">													contentModelExist = true;</span>
<span class="nc" id="L579">													break;</span>
												}
<span class="nc" id="L581">											}</span>
<span class="nc bnc" id="L582" title="All 2 branches missed.">											if (!contentModelExist) {</span>
<span class="nc" id="L583">												modelContenutoSostitutivo = contentToReplace.getDefaultModel();</span>
											}
										}
										// scorro la lista di pagine
<span class="nc bnc" id="L587" title="All 2 branches missed.">										for (IPage page : listaPagine) {</span>
<span class="nc" id="L588">											int framePos = -1;</span>
<span class="nc" id="L589">											Widget widget = null;</span>
<span class="nc bnc" id="L590" title="All 2 branches missed.">											for (int i = 0; i &lt; page.getWidgets().length; i++) {</span>
<span class="nc" id="L591">												Widget w = page.getWidgets()[i];</span>
<span class="nc bnc" id="L592" title="All 2 branches missed.">												if (w != null) {</span>
<span class="nc bnc" id="L593" title="All 2 branches missed.">													if (w.getConfig() != null) {</span>
<span class="nc" id="L594">														ApsProperties prop = w.getConfig();</span>
<span class="nc" id="L595">														String codeContentPage = prop.getProperty(&quot;contentId&quot;);</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">														if (codeContentPage.equalsIgnoreCase(contentToMove.getId())) {</span>
															// trova il widget
															// ed il framepos,
															// poi setta il
															// contenuto
															// sotitutivo
<span class="nc" id="L602">															ApsProperties propconfig = new ApsProperties();</span>
<span class="nc" id="L603">															propconfig.setProperty(&quot;contentId&quot;, contenutoSostitutivo);</span>
<span class="nc bnc" id="L604" title="All 2 branches missed.">															if (modelContenutoSostitutivo != null) {</span>
<span class="nc" id="L605">																propconfig.setProperty(&quot;modelId&quot;,</span>
																		modelContenutoSostitutivo);
															}
<span class="nc" id="L608">															w.setConfig(propconfig);</span>
<span class="nc" id="L609">															framePos = i;</span>
<span class="nc" id="L610">															widget = w;</span>
<span class="nc" id="L611">															break;</span>
														}
													}
												}
											} // fine ciclo dei widget
<span class="nc bnc" id="L616" title="All 4 branches missed.">											if (framePos != -1 &amp;&amp; widget != null) {</span>
<span class="nc" id="L617">												this.getPageManager().joinWidget(page.getCode(), widget, framePos);</span>
<span class="nc" id="L618">                                                                                                this.getPageManager().setPageOnline(page.getCode());</span>
<span class="nc" id="L619">												operation = &quot;replaceContent&quot;;</span>
											}
<span class="nc" id="L621">										}</span>
<span class="nc" id="L622">									} else {</span>
<span class="nc" id="L623">										moveContents.add(new ContentState(contentToMove.getId(),</span>
<span class="nc" id="L624">												contentToMove.getTypeCode(), contentToMove.getDescription(),</span>
												ContentThreadConstants.SUSPEND_ACTION,
												ContentThreadConstants.CONTENT_WITH_REFERENCES));
<span class="nc" id="L627">										ApsSystemUtils.getLogger()</span>
<span class="nc" id="L628">												.info(&quot;Spostamento automatico in archivio: &quot; + contentToMove.getId()</span>
														+ &quot; - &quot; + ContentThreadConstants.CONTENT_WITH_REFERENCES);
<span class="nc" id="L630">										continue;</span>
									}
								}
							}
							// Aggiungo la categoria globale, se non sono state
							// precisate categorie assegnate al tipo di
							// contenuto
<span class="nc" id="L637">							Category catGlobal = null;</span>
<span class="nc bnc" id="L638" title="All 2 branches missed.">							if (c.getGlobalCat() != null) {</span>
<span class="nc" id="L639">								catGlobal = this.getCategoryManager().getCategory(c.getGlobalCat());</span>
							} else {
								// senza categoria globale non posso effettuare
								// lo spostamento o la depubblicazione
<span class="nc" id="L643">								ApsSystemUtils.getLogger().info(</span>
										&quot;Errore nella Sospensione/Spostamento dei contenuti, manca l'attributo 'globalcat' nella configurazione del plugin&quot;);
<span class="nc" id="L645">								continue;</span>
							}
<span class="nc bnc" id="L647" title="All 4 branches missed.">							if (c.getCatType() != null &amp;&amp; c.getCatType().size() &gt; 0) {</span>
<span class="nc bnc" id="L648" title="All 2 branches missed.">								for (String code : c.getCatType()) {</span>
<span class="nc" id="L649">									Category cat = this.getCategoryManager().getCategory(code);</span>
<span class="nc bnc" id="L650" title="All 2 branches missed.">									if (!contentToMove.getCategories().contains(cat)) {</span>
<span class="nc" id="L651">										contentToMove.addCategory(cat);</span>
<span class="nc" id="L652">										alreadyMove = true;</span>
									}
<span class="nc" id="L654">								}</span>
							} else {
<span class="nc bnc" id="L656" title="All 2 branches missed.">								if (catGlobal == null) {</span>
<span class="nc" id="L657">									ApsSystemUtils.getLogger().info(</span>
											&quot;Errore nella Sospensione/Spostamento dei contenuti, l'attributo 'globalcat' non corrisponde ad alcuna categoria esistente&quot;);
<span class="nc" id="L659">									continue;</span>
								}
<span class="nc bnc" id="L661" title="All 2 branches missed.">								if (!contentToMove.getCategories().contains(catGlobal)) {</span>
<span class="nc" id="L662">									contentToMove.addCategory(catGlobal);</span>
<span class="nc" id="L663">									alreadyMove = true;</span>
								}
							}
<span class="nc bnc" id="L666" title="All 4 branches missed.">							if (!alreadyMove &amp;&amp; operation.equals(&quot;move&quot;)) {</span>
								// se non son state inserite nuove categorie -
								// non c'è bisogno di effettuare il save
								// se non c'è stata alcuna sostituzione nelle
								// pagine
<span class="nc" id="L671">								ApsSystemUtils.getLogger().info(</span>
<span class="nc" id="L672">										&quot;Spostamento automatico in archivio non riuscito: &quot; + contentToMove.getId());</span>
<span class="nc" id="L673">								moveContents.add(new ContentState(contentToMove.getId(), contentToMove.getTypeCode(),</span>
<span class="nc" id="L674">										contentToMove.getDescription(), ContentThreadConstants.MOVE_ACTION,</span>
										ContentThreadConstants.ISALREADYMOVED));
<span class="nc" id="L676">								continue;</span>
<span class="nc bnc" id="L677" title="All 4 branches missed.">							} else if (!alreadyMove &amp;&amp; operation.equals(&quot;replaceContent&quot;)) {// se</span>
																							// c'è
																							// stata
																							// una
																							// sostituzione
<span class="nc" id="L682">								ApsSystemUtils.getLogger()</span>
<span class="nc" id="L683">										.info(&quot;Spostamento automatico contenuto &quot; + contentToMove.getId());</span>
<span class="nc" id="L684">								moveContents.add(new ContentState(contentToMove.getId(), contentToMove.getTypeCode(),</span>
<span class="nc" id="L685">										contentToMove.getDescription() + &quot; - &quot; + ContentThreadConstants.REPLACE_CONTENT,</span>
										ContentThreadConstants.MOVE_ACTION, ContentThreadConstants.ACTION_SUCCESS));
<span class="nc" id="L687">								continue;</span>
							}
							// Spostamento del contenuto in archivio - senza
							// modifica della data di ultima mod e senza
							// depubblicazione
<span class="nc" id="L692">							this.getContentSchedulerManager().moveOnLineContent(contentToMove, false, false);</span>
<span class="nc bnc" id="L693" title="All 4 branches missed.">							if (alreadyMove &amp;&amp; operation.equals(&quot;move&quot;)) {</span>
<span class="nc" id="L694">								ApsSystemUtils.getLogger()</span>
<span class="nc" id="L695">										.info(&quot;Spostamento automatico contenuto &quot; + contentToMove.getId());</span>
<span class="nc" id="L696">								moveContents.add(new ContentState(contentToMove.getId(), contentToMove.getTypeCode(),</span>
<span class="nc" id="L697">										contentToMove.getDescription(), ContentThreadConstants.MOVE_ACTION,</span>
										ContentThreadConstants.ACTION_SUCCESS));
<span class="nc bnc" id="L699" title="All 4 branches missed.">							} else if (alreadyMove &amp;&amp; operation.equals(&quot;replaceContent&quot;)) {</span>
<span class="nc" id="L700">								ApsSystemUtils.getLogger()</span>
<span class="nc" id="L701">										.info(&quot;Spostamento automatico contenuto &quot; + contentToMove.getId());</span>
<span class="nc" id="L702">								moveContents.add(new ContentState(contentToMove.getId(), contentToMove.getTypeCode(),</span>
<span class="nc" id="L703">										contentToMove.getDescription() + &quot; - &quot; + ContentThreadConstants.REPLACE_CONTENT,</span>
										ContentThreadConstants.MOVE_ACTION, ContentThreadConstants.ACTION_SUCCESS));
							}
<span class="nc" id="L706">						} catch (Throwable t) {</span>
<span class="nc" id="L707">							ApsSystemUtils.logThrowable(t, this, ContentThreadConstants.UNEXPECTED_ERROR);</span>
<span class="nc" id="L708">							moveContents.add(new ContentState(contentId, &quot;null&quot;, &quot;null&quot;,</span>
<span class="nc" id="L709">									ContentThreadConstants.MOVE_ACTION, t.getMessage()));</span>
<span class="nc" id="L710">						}</span>
<span class="nc" id="L711">					} // chiusura while</span>
<span class="nc" id="L712">				} else {</span>
<span class="nc" id="L713">					ApsSystemUtils.getLogger()</span>
<span class="nc" id="L714">							.info(&quot;Errore nella Sospensione/Spostamento dei contenuti, manca l'attributo suspend nella configurazione del tipo di contenuto &quot;</span>
<span class="nc" id="L715">									+ c.getTypeContent());</span>
<span class="nc" id="L716">					continue;</span>
				}
<span class="fc" id="L718">			}</span>
<span class="nc" id="L719">		} catch (Throwable t) {</span>
<span class="nc" id="L720">			ApsSystemUtils.logThrowable(t, this, &quot;removeOnLine&quot;);</span>
<span class="nc" id="L721">			throw new RuntimeException(&quot;Errore in sospensione contenuti online&quot;, t);</span>
<span class="fc" id="L722">		}</span>
<span class="fc" id="L723">	}</span>

	public IContentManager getContentManager() {
<span class="nc" id="L726">		return _contentManager;</span>
	}

	public void setContentManager(IContentManager manager) {
<span class="fc" id="L730">		this._contentManager = manager;</span>
<span class="fc" id="L731">	}</span>

	public IContentSchedulerManager getContentSchedulerManager() {
<span class="fc" id="L734">		return _contentSchedulerManager;</span>
	}

	public void setContentSchedulerManager(IContentSchedulerManager contentSchedulerManager) {
<span class="fc" id="L738">		this._contentSchedulerManager = contentSchedulerManager;</span>
<span class="fc" id="L739">	}</span>

	public ICategoryManager getCategoryManager() {
<span class="nc" id="L742">		return _categoryManager;</span>
	}

	public void setCategoryManager(ICategoryManager categoryManager) {
<span class="fc" id="L746">		this._categoryManager = categoryManager;</span>
<span class="fc" id="L747">	}</span>

	public IPageManager getPageManager() {
<span class="nc" id="L750">		return _pageManager;</span>
	}

	public void setPageManager(IPageManager pageManager) {
<span class="fc" id="L754">		this._pageManager = pageManager;</span>
<span class="fc" id="L755">	}</span>

	public IContentModelManager getContentModelManager() {
<span class="nc" id="L758">		return _contentModelManager;</span>
	}

	public void setContentModelManager(IContentModelManager contentModelManager) {
<span class="fc" id="L762">		this._contentModelManager = contentModelManager;</span>
<span class="fc" id="L763">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>