<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DataObjectDAO.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Entando Core: Engine</a> &gt; <a href="index.source.html" class="el_package">org.entando.entando.aps.system.services.dataobject</a> &gt; <span class="el_source">DataObjectDAO.java</span></div><h1>DataObjectDAO.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2015-Present Entando Inc. (http://www.entando.com) All rights reserved.
 *
 * This library is free software; you can redistribute it and/or modify it under
 * the terms of the GNU Lesser General Public License as published by the Free
 * Software Foundation; either version 2.1 of the License, or (at your option)
 * any later version.
 *
 * This library is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
 * details.
 */
package org.entando.entando.aps.system.services.dataobject;

import com.agiletec.aps.system.SystemConstants;
import java.sql.BatchUpdateException;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Set;

import org.entando.entando.ent.util.EntLogging.EntLogger;
import org.entando.entando.ent.util.EntLogging.EntLogFactory;

import com.agiletec.aps.system.common.entity.AbstractEntityDAO;
import com.agiletec.aps.system.common.entity.model.ApsEntityRecord;
import com.agiletec.aps.system.common.entity.model.IApsEntity;
import com.agiletec.aps.system.common.entity.model.attribute.AttributeInterface;
import com.agiletec.aps.system.common.util.EntityAttributeIterator;
import org.entando.entando.ent.exception.EntException;
import com.agiletec.aps.system.services.category.Category;
import com.agiletec.aps.system.services.category.ICategoryManager;
import com.agiletec.aps.util.DateConverter;
import org.entando.entando.aps.system.services.dataobject.model.DataObject;
import org.entando.entando.aps.system.services.dataobject.model.DataObjectRecordVO;

/**
 * DAO class for objects of type dataobject.
 *
 * @author M.Diana - E.Santoboni - S.Didaci
 */
<span class="fc" id="L49">public class DataObjectDAO extends AbstractEntityDAO implements IDataObjectDAO {</span>

<span class="fc" id="L51">    private static final EntLogger _logger = EntLogFactory.getSanitizedLogger(DataObjectDAO.class);</span>
    
    private ICategoryManager categoryManager;

    @Override
    protected String getLoadEntityRecordQuery() {
<span class="fc" id="L57">        return LOAD_DATAOBJECT_VO;</span>
    }

    @Override
    protected ApsEntityRecord createEntityRecord(ResultSet res) throws Throwable {
<span class="fc" id="L62">        DataObjectRecordVO dataobjectVo = new DataObjectRecordVO();</span>
<span class="fc" id="L63">        dataobjectVo.setId(res.getString(1));</span>
<span class="fc" id="L64">        dataobjectVo.setTypeCode(res.getString(2));</span>
<span class="fc" id="L65">        dataobjectVo.setDescription(res.getString(3));</span>
<span class="fc" id="L66">        dataobjectVo.setStatus(res.getString(4));</span>
<span class="fc" id="L67">        String xmlWork = res.getString(5);</span>
<span class="fc" id="L68">        dataobjectVo.setCreate(DateConverter.parseDate(res.getString(6), SystemConstants.DATA_TYPE_METADATA_DATE_FORMAT));</span>
<span class="fc" id="L69">        dataobjectVo.setModify(DateConverter.parseDate(res.getString(7), SystemConstants.DATA_TYPE_METADATA_DATE_FORMAT));</span>
<span class="fc" id="L70">        String xmlOnLine = res.getString(8);</span>
<span class="pc bpc" id="L71" title="1 of 4 branches missed.">        dataobjectVo.setOnLine(null != xmlOnLine &amp;&amp; xmlOnLine.length() &gt; 0);</span>
<span class="fc" id="L72">        dataobjectVo.setSync(xmlWork.equals(xmlOnLine));</span>
<span class="fc" id="L73">        String mainGroupCode = res.getString(9);</span>
<span class="fc" id="L74">        dataobjectVo.setMainGroupCode(mainGroupCode);</span>
<span class="fc" id="L75">        dataobjectVo.setXmlWork(xmlWork);</span>
<span class="fc" id="L76">        dataobjectVo.setXmlOnLine(xmlOnLine);</span>
<span class="fc" id="L77">        dataobjectVo.setVersion(res.getString(10));</span>
<span class="fc" id="L78">        dataobjectVo.setFirstEditor(res.getString(11));</span>
<span class="fc" id="L79">        dataobjectVo.setLastEditor(res.getString(12));</span>
<span class="fc" id="L80">        return dataobjectVo;</span>
    }

    @Override
    protected void executeAddEntity(IApsEntity entity, Connection conn) throws Throwable {
<span class="fc" id="L85">        super.executeAddEntity(entity, conn);</span>
<span class="fc" id="L86">        this.addDataObjectRelationsRecord((DataObject) entity, conn);</span>
<span class="fc" id="L87">    }</span>

    @Override
    protected String getAddEntityRecordQuery() {
<span class="fc" id="L91">        return ADD_DATAOBJECT;</span>
    }

    @Override
    protected void buildAddEntityStatement(IApsEntity entity, PreparedStatement stat) throws Throwable {
<span class="fc" id="L96">        DataObject dataobject = (DataObject) entity;</span>
<span class="fc" id="L97">        stat.setString(1, dataobject.getId());</span>
<span class="fc" id="L98">        stat.setString(2, dataobject.getTypeCode());</span>
<span class="fc" id="L99">        stat.setString(3, dataobject.getDescription());</span>
<span class="fc" id="L100">        stat.setString(4, dataobject.getStatus());</span>
<span class="fc" id="L101">        stat.setString(5, dataobject.getXML());</span>
<span class="fc" id="L102">        String currentDate = DateConverter.getFormattedDate(new Date(), SystemConstants.DATA_TYPE_METADATA_DATE_FORMAT);</span>
<span class="fc" id="L103">        stat.setString(6, currentDate);</span>
<span class="fc" id="L104">        stat.setString(7, currentDate);</span>
<span class="fc" id="L105">        stat.setString(8, dataobject.getXML());</span>
<span class="fc" id="L106">        stat.setString(9, dataobject.getMainGroup());</span>
<span class="fc" id="L107">        stat.setString(10, dataobject.getVersion());</span>
<span class="fc" id="L108">        stat.setString(11, dataobject.getFirstEditor());</span>
<span class="fc" id="L109">        stat.setString(12, dataobject.getLastEditor());</span>
<span class="fc" id="L110">    }</span>

    @Override
    public void updateDataObject(DataObject dataobject, boolean updateDate) {
<span class="fc" id="L114">        Connection conn = null;</span>
        try {
<span class="fc" id="L116">            conn = this.getConnection();</span>
<span class="fc" id="L117">            conn.setAutoCommit(false);</span>
<span class="fc" id="L118">            this.executeUpdateData(dataobject, updateDate, conn);</span>
<span class="fc" id="L119">            conn.commit();</span>
<span class="nc" id="L120">        } catch (Throwable t) {</span>
<span class="nc" id="L121">            this.executeRollback(conn);</span>
<span class="nc" id="L122">            _logger.error(&quot;Error updating dataobject&quot;, t);</span>
<span class="nc" id="L123">            throw new RuntimeException(&quot;Error updating dataobject&quot;, t);</span>
        } finally {
<span class="fc" id="L125">            this.closeConnection(conn);</span>
        }
<span class="fc" id="L127">    }</span>

    protected void executeUpdateData(DataObject dataobject, boolean updateDate, Connection conn) throws Throwable {
<span class="fc" id="L130">        PreparedStatement stat = null;</span>
        try {
<span class="fc" id="L132">            this.deleteRecordsByEntityId(dataobject.getId(), DELETE_DATAOBJECT_REL_RECORD, conn);</span>
<span class="fc" id="L133">            this.deleteRecordsByEntityId(dataobject.getId(), this.getRemovingSearchRecordQuery(), conn);</span>
<span class="fc" id="L134">            this.deleteRecordsByEntityId(dataobject.getId(), this.getRemovingAttributeRoleRecordQuery(), conn);</span>
<span class="pc bpc" id="L135" title="1 of 2 branches missed.">            if (updateDate) {</span>
<span class="fc" id="L136">                stat = conn.prepareStatement(this.getUpdateEntityRecordQuery());</span>
            } else {
<span class="nc" id="L138">                stat = conn.prepareStatement(this.getUpdateEntityRecordQueryWithoutDate());</span>
            }
<span class="fc" id="L140">            this.buildUpdateEntityStatement(dataobject, updateDate, stat);</span>
<span class="fc" id="L141">            stat.executeUpdate();</span>
<span class="fc" id="L142">            this.addEntitySearchRecord(dataobject.getId(), dataobject, conn);</span>
<span class="fc" id="L143">            this.addEntityAttributeRoleRecord(dataobject.getId(), dataobject, conn);</span>
<span class="fc" id="L144">            this.addDataObjectRelationsRecord(dataobject, conn);</span>
<span class="nc" id="L145">        } catch (Throwable t) {</span>
<span class="nc" id="L146">            throw t;</span>
        } finally {
<span class="fc" id="L148">            this.closeDaoResources(null, stat);</span>
        }
<span class="fc" id="L150">    }</span>

    @Override
    protected void executeUpdateEntity(IApsEntity entity, Connection conn) throws Throwable {
<span class="fc" id="L154">        this.deleteRecordsByEntityId(entity.getId(), DELETE_DATAOBJECT_REL_RECORD, conn);</span>
<span class="fc" id="L155">        super.executeUpdateEntity(entity, conn);</span>
<span class="fc" id="L156">        this.addDataObjectRelationsRecord((DataObject) entity, conn);</span>
<span class="fc" id="L157">    }</span>

    @Override
    protected String getUpdateEntityRecordQuery() {
<span class="fc" id="L161">        return UPDATE_DATAOBJECT;</span>
    }

    protected String getUpdateEntityRecordQueryWithoutDate() {
<span class="nc" id="L165">        return UPDATE_DATAOBJECT_WITHOUT_DATE;</span>
    }

    @Override
    protected void buildUpdateEntityStatement(IApsEntity entity, PreparedStatement stat) throws Throwable {
<span class="fc" id="L170">        this.buildUpdateEntityStatement(entity, true, stat);</span>
<span class="fc" id="L171">    }</span>

    protected void buildUpdateEntityStatement(IApsEntity entity, boolean updateDate, PreparedStatement stat) throws Throwable {
<span class="fc" id="L174">        DataObject dataobject = (DataObject) entity;</span>
<span class="fc" id="L175">        int index = 1;</span>
<span class="fc" id="L176">        stat.setString(index++, dataobject.getTypeCode());</span>
<span class="fc" id="L177">        stat.setString(index++, dataobject.getDescription());</span>
<span class="fc" id="L178">        stat.setString(index++, dataobject.getStatus());</span>
<span class="fc" id="L179">        stat.setString(index++, dataobject.getXML());</span>
<span class="pc bpc" id="L180" title="1 of 2 branches missed.">        if (updateDate) {</span>
<span class="fc" id="L181">            stat.setString(index++, DateConverter.getFormattedDate(new Date(), SystemConstants.DATA_TYPE_METADATA_DATE_FORMAT));</span>
        }
<span class="fc" id="L183">        stat.setString(index++, dataobject.getMainGroup());</span>
<span class="fc" id="L184">        stat.setString(index++, dataobject.getVersion());</span>
<span class="fc" id="L185">        stat.setString(index++, dataobject.getLastEditor());</span>
<span class="fc" id="L186">        stat.setString(index++, dataobject.getId());</span>
<span class="fc" id="L187">    }</span>

    /**
     * This publishes a dataobject.
     *
     * @param dataobject the dataobject to publish.
     */
    @Override
    public void insertDataObject(DataObject dataobject) {
<span class="fc" id="L196">        Connection conn = null;</span>
        try {
<span class="fc" id="L198">            conn = this.getConnection();</span>
<span class="fc" id="L199">            conn.setAutoCommit(false);</span>
<span class="fc" id="L200">            this.executeInsertDataObject(dataobject, conn);</span>
<span class="fc" id="L201">            conn.commit();</span>
<span class="nc" id="L202">        } catch (Throwable t) {</span>
<span class="nc" id="L203">            this.executeRollback(conn);</span>
<span class="nc" id="L204">            _logger.error(&quot;Error publish dataobject {} &quot;, dataobject.getId(), t);</span>
<span class="nc" id="L205">            throw new RuntimeException(&quot;Error publish dataobject - &quot; + dataobject.getId(), t);</span>
        } finally {
<span class="fc" id="L207">            this.closeConnection(conn);</span>
        }
<span class="fc" id="L209">    }</span>

    protected void executeInsertDataObject(DataObject dataobject, Connection conn) throws Throwable {
<span class="fc" id="L212">        this.executeInsertDataObject(dataobject, true, conn);</span>
<span class="fc" id="L213">    }</span>

    protected void executeInsertDataObject(DataObject dataobject, boolean updateDate, Connection conn) throws Throwable {
<span class="fc" id="L216">        super.deleteRecordsByEntityId(dataobject.getId(), DELETE_DATAOBJECT_SEARCH_RECORD, conn);</span>
<span class="fc" id="L217">        super.deleteRecordsByEntityId(dataobject.getId(), DELETE_ATTRIBUTE_ROLE_RECORD, conn);</span>
<span class="fc" id="L218">        super.deleteEntitySearchRecord(dataobject.getId(), conn);</span>
<span class="fc" id="L219">        super.deleteRecordsByEntityId(dataobject.getId(), DELETE_DATAOBJECT_REL_RECORD, conn);</span>
<span class="fc" id="L220">        this.updateDataObjectRecordForInsert(dataobject, updateDate, conn);</span>
<span class="fc" id="L221">        this.addDataObjectSearchRecord(dataobject.getId(), dataobject, conn);</span>
<span class="fc" id="L222">        super.addEntitySearchRecord(dataobject.getId(), dataobject, conn);</span>
<span class="fc" id="L223">        this.addDataObjectAttributeRoleRecord(dataobject.getId(), dataobject, ADD_ATTRIBUTE_ROLE_RECORD, conn);</span>
<span class="fc" id="L224">        this.addDataObjectRelationsRecord(dataobject, conn);</span>
<span class="fc" id="L225">    }</span>

    protected void addDataObjectSearchRecord(String id, IApsEntity entity, Connection conn) {
<span class="fc" id="L228">        PreparedStatement stat = null;</span>
        try {
<span class="fc" id="L230">            stat = conn.prepareStatement(ADD_DATAOBJECT_SEARCH_RECORD);</span>
<span class="fc" id="L231">            this.addEntitySearchRecord(id, entity, stat);</span>
<span class="nc" id="L232">        } catch (Throwable t) {</span>
<span class="nc" id="L233">            _logger.error(&quot;Error on adding public dataobject search records&quot;, t);</span>
<span class="nc" id="L234">            throw new RuntimeException(&quot;Error on adding public dataobject search records&quot;, t);</span>
        } finally {
<span class="fc" id="L236">            closeDaoResources(null, stat);</span>
        }
<span class="fc" id="L238">    }</span>

    protected void updateDataObjectRecordForInsert(DataObject dataobject, Connection conn) {
<span class="nc" id="L241">        this.updateDataObjectRecordForInsert(dataobject, true, conn);</span>
<span class="nc" id="L242">    }</span>

    protected void updateDataObjectRecordForInsert(DataObject dataobject, boolean updateDate, Connection conn) {
<span class="fc" id="L245">        PreparedStatement stat = null;</span>
        try {
<span class="fc" id="L247">            int index = 1;</span>
<span class="pc bpc" id="L248" title="1 of 2 branches missed.">            if (updateDate) {</span>
<span class="fc" id="L249">                stat = conn.prepareStatement(INSERT_DATAOBJECT);</span>
            } else {
<span class="nc" id="L251">                stat = conn.prepareStatement(INSERT_DATAOBJECT_WITHOUT_DATE);</span>
            }
<span class="fc" id="L253">            stat.setString(index++, dataobject.getTypeCode());</span>
<span class="fc" id="L254">            stat.setString(index++, dataobject.getDescription());</span>
<span class="fc" id="L255">            stat.setString(index++, dataobject.getStatus());</span>
<span class="fc" id="L256">            String xml = dataobject.getXML();</span>
<span class="fc" id="L257">            stat.setString(index++, xml);</span>
<span class="pc bpc" id="L258" title="1 of 2 branches missed.">            if (updateDate) {</span>
<span class="fc" id="L259">                stat.setString(index++, DateConverter.getFormattedDate(new Date(), SystemConstants.DATA_TYPE_METADATA_DATE_FORMAT));</span>
            }
<span class="fc" id="L261">            stat.setString(index++, xml);</span>
<span class="fc" id="L262">            stat.setString(index++, dataobject.getMainGroup());</span>
<span class="fc" id="L263">            stat.setString(index++, dataobject.getVersion());</span>
<span class="fc" id="L264">            stat.setString(index++, dataobject.getLastEditor());</span>
<span class="fc" id="L265">            stat.setString(index++, dataobject.getId());</span>
<span class="fc" id="L266">            stat.executeUpdate();</span>
<span class="nc" id="L267">        } catch (Throwable t) {</span>
<span class="nc" id="L268">            _logger.error(&quot;Error updating for insert onLine dataobject {}&quot;, dataobject.getId(), t);</span>
<span class="nc" id="L269">            throw new RuntimeException(&quot;Error updating for insert onLine dataobject &quot; + dataobject.getId(), t);</span>
        } finally {
<span class="fc" id="L271">            closeDaoResources(null, stat);</span>
        }
<span class="fc" id="L273">    }</span>

    /**
     * Updates the references of a published dataobject
     *
     * @param dataobject the published dataobject
     */
    @Override
    public void reloadDataObjectReferences(DataObject dataobject) {
<span class="pc bpc" id="L282" title="1 of 2 branches missed.">        if (dataobject.isOnLine()) {</span>
<span class="fc" id="L283">            Connection conn = null;</span>
            try {
<span class="fc" id="L285">                conn = this.getConnection();</span>
<span class="fc" id="L286">                conn.setAutoCommit(false);</span>
<span class="fc" id="L287">                this.executeReloadDataObjectReferences(dataobject, conn);</span>
<span class="fc" id="L288">                conn.commit();</span>
<span class="nc" id="L289">            } catch (Throwable t) {</span>
<span class="nc" id="L290">                this.executeRollback(conn);</span>
<span class="nc" id="L291">                _logger.error(&quot;Error reloading references - Data {}&quot;, dataobject.getId(), t);</span>
<span class="nc" id="L292">                throw new RuntimeException(&quot;Error reloading references - Data &quot; + dataobject.getId(), t);</span>
            } finally {
<span class="fc" id="L294">                this.closeConnection(conn);</span>
            }
        }
<span class="fc" id="L297">    }</span>

    protected void executeReloadDataObjectReferences(DataObject dataobject, Connection conn) throws Throwable {
<span class="fc" id="L300">        super.deleteRecordsByEntityId(dataobject.getId(), DELETE_DATAOBJECT_SEARCH_RECORD, conn);</span>
<span class="fc" id="L301">        super.deleteRecordsByEntityId(dataobject.getId(), DELETE_DATAOBJECT_REL_RECORD, conn);</span>
<span class="fc" id="L302">        super.deleteRecordsByEntityId(dataobject.getId(), DELETE_ATTRIBUTE_ROLE_RECORD, conn);</span>
<span class="fc" id="L303">        this.addDataObjectSearchRecord(dataobject.getId(), dataobject, conn);</span>
<span class="fc" id="L304">        this.addDataObjectRelationsRecord(dataobject, conn);</span>
<span class="fc" id="L305">        this.addDataObjectAttributeRoleRecord(dataobject.getId(), dataobject, ADD_ATTRIBUTE_ROLE_RECORD, conn);</span>
<span class="fc" id="L306">    }</span>

    /**
     * Unpublish a dataobject, preventing it from being displayed in the portal.
     * Obviously the dataobject itslef is not deleted.
     *
     * @param dataobject the dataobject to unpublish.
     */
    @Override
    public void removeDataObject(DataObject dataobject) {
<span class="fc" id="L316">        Connection conn = null;</span>
        try {
<span class="fc" id="L318">            conn = this.getConnection();</span>
<span class="fc" id="L319">            conn.setAutoCommit(false);</span>
<span class="fc" id="L320">            this.executeRemoveDataObject(dataobject, conn);</span>
<span class="fc" id="L321">            conn.commit();</span>
<span class="nc" id="L322">        } catch (Throwable t) {</span>
<span class="nc" id="L323">            this.executeRollback(conn);</span>
<span class="nc" id="L324">            _logger.error(&quot;Error removing online dataobject {}&quot;, dataobject.getId(), t);</span>
<span class="nc" id="L325">            throw new RuntimeException(&quot;Error removing online dataobject - &quot; + dataobject.getId(), t);</span>
        } finally {
<span class="fc" id="L327">            this.closeConnection(conn);</span>
        }
<span class="fc" id="L329">    }</span>

    protected void executeRemoveDataObject(DataObject dataobject, Connection conn) {
<span class="fc" id="L332">        this.executeRemoveDataObject(dataobject, true, conn);</span>
<span class="fc" id="L333">    }</span>

    /**
     * Unpublish a dataobject, preventing it from being displayed in the portal.
     * Obviously the dataobject itslef is not deleted.
     *
     * @param dataobject the dataobject to unpublish.
     * @param updateDate
     * @param conn the connection to the DB.
     */
    protected void executeRemoveDataObject(DataObject dataobject, boolean updateDate, Connection conn) {
<span class="fc" id="L344">        super.deleteRecordsByEntityId(dataobject.getId(), DELETE_DATAOBJECT_SEARCH_RECORD, conn);</span>
<span class="fc" id="L345">        super.deleteRecordsByEntityId(dataobject.getId(), DELETE_DATAOBJECT_REL_RECORD, conn);</span>
<span class="fc" id="L346">        super.deleteRecordsByEntityId(dataobject.getId(), DELETE_ATTRIBUTE_ROLE_RECORD, conn);</span>
<span class="fc" id="L347">        PreparedStatement stat = null;</span>
        try {
<span class="pc bpc" id="L349" title="1 of 2 branches missed.">            if (updateDate) {</span>
<span class="fc" id="L350">                stat = conn.prepareStatement(REMOVE_DATAOBJECT);</span>
            } else {
<span class="nc" id="L352">                stat = conn.prepareStatement(REMOVE_DATAOBJECT_WITHOUT_DATE);</span>
            }
<span class="fc" id="L354">            int index = 1;</span>
<span class="fc" id="L355">            stat.setString(index++, null);</span>
<span class="fc" id="L356">            stat.setString(index++, dataobject.getStatus());</span>
<span class="fc" id="L357">            stat.setString(index++, dataobject.getXML());</span>
<span class="pc bpc" id="L358" title="1 of 2 branches missed.">            if (updateDate) {</span>
<span class="fc" id="L359">                stat.setString(index++, DateConverter.getFormattedDate(new Date(), SystemConstants.DATA_TYPE_METADATA_DATE_FORMAT));</span>
            }
<span class="fc" id="L361">            stat.setString(index++, dataobject.getVersion());</span>
<span class="fc" id="L362">            stat.setString(index++, dataobject.getLastEditor());</span>
<span class="fc" id="L363">            stat.setString(index++, dataobject.getId());</span>
<span class="fc" id="L364">            stat.executeUpdate();</span>
<span class="nc" id="L365">        } catch (Throwable t) {</span>
<span class="nc" id="L366">            _logger.error(&quot;Error removing online dataobject {}&quot;, dataobject.getId(), t);</span>
<span class="nc" id="L367">            throw new RuntimeException(&quot;Error removing online dataobject - &quot; + dataobject.getId(), t);</span>
        } finally {
<span class="fc" id="L369">            closeDaoResources(null, stat);</span>
        }
<span class="fc" id="L371">    }</span>

    @Override
    protected String getDeleteEntityRecordQuery() {
<span class="fc" id="L375">        return DELETE_DATAOBJECT;</span>
    }

    @Override
    protected void executeDeleteEntity(String entityId, Connection conn) throws Throwable {
<span class="fc" id="L380">        super.deleteRecordsByEntityId(entityId, DELETE_DATAOBJECT_SEARCH_RECORD, conn);</span>
<span class="fc" id="L381">        super.deleteRecordsByEntityId(entityId, DELETE_DATAOBJECT_REL_RECORD, conn);</span>
<span class="fc" id="L382">        super.deleteRecordsByEntityId(entityId, DELETE_ATTRIBUTE_ROLE_RECORD, conn);</span>
<span class="fc" id="L383">        super.executeDeleteEntity(entityId, conn);</span>
<span class="fc" id="L384">    }</span>

    private void addCategoryRelationsRecord(DataObject dataobject, boolean isPublicRelations, PreparedStatement stat) {
<span class="fc bfc" id="L387" title="All 2 branches covered.">        if (dataobject.getCategories().size() &gt; 0) {</span>
            try {
<span class="fc" id="L389">                Set&lt;String&gt; codes = new HashSet&lt;String&gt;();</span>
<span class="fc" id="L390">                Iterator&lt;Category&gt; categoryIter = dataobject.getCategories().iterator();</span>
<span class="fc bfc" id="L391" title="All 2 branches covered.">                while (categoryIter.hasNext()) {</span>
<span class="fc" id="L392">                    Category category = (Category) categoryIter.next();</span>
<span class="fc" id="L393">                    this.addCategoryCode(category, codes);</span>
<span class="fc" id="L394">                }</span>
<span class="fc" id="L395">                Iterator&lt;String&gt; codeIter = codes.iterator();</span>
<span class="fc bfc" id="L396" title="All 2 branches covered.">                while (codeIter.hasNext()) {</span>
<span class="fc" id="L397">                    String code = codeIter.next();</span>
<span class="fc" id="L398">                    int i = 1;</span>
<span class="fc" id="L399">                    stat.setString(i++, dataobject.getId());</span>
                    /*
					if (isPublicRelations) {
						stat.setString(i++, null);
						stat.setString(i++, null);
						stat.setBigDecimal(i++, null);
					}
                     */
<span class="fc" id="L407">                    stat.setString(i++, code);</span>
<span class="pc bpc" id="L408" title="1 of 2 branches missed.">                    if (isPublicRelations) {</span>
<span class="fc" id="L409">                        stat.setString(i++, null);</span>
                    }
<span class="fc" id="L411">                    stat.addBatch();</span>
<span class="fc" id="L412">                    stat.clearParameters();</span>
<span class="fc" id="L413">                }</span>
<span class="nc" id="L414">            } catch (SQLException e) {</span>
<span class="nc" id="L415">                _logger.error(&quot;Error saving dataobject relation record for dataobject {}&quot;, dataobject.getId(), e.getNextException());</span>
<span class="nc" id="L416">                throw new RuntimeException(&quot;Error saving dataobject relation record for dataobject &quot; + dataobject.getId(), e.getNextException());</span>
<span class="fc" id="L417">            }</span>
        }
<span class="fc" id="L419">    }</span>

    private void addCategoryCode(Category category, Set&lt;String&gt; codes) {
<span class="fc" id="L422">        codes.add(category.getCode());</span>
<span class="fc" id="L423">        Category parentCategory = this.getCategoryManager().getCategory(category.getParentCode());</span>
<span class="pc bpc" id="L424" title="1 of 4 branches missed.">        if (null != parentCategory &amp;&amp; !parentCategory.getCode().equals(parentCategory.getParentCode())) {</span>
<span class="fc" id="L425">            this.addCategoryCode(parentCategory, codes);</span>
        }
<span class="fc" id="L427">    }</span>

    private void addGroupRelationsRecord(DataObject dataobject, PreparedStatement stat) {
        try {
<span class="fc" id="L431">            dataobject.addGroup(dataobject.getMainGroup());</span>
<span class="fc" id="L432">            Iterator&lt;String&gt; groupIter = dataobject.getGroups().iterator();</span>
<span class="fc bfc" id="L433" title="All 2 branches covered.">            while (groupIter.hasNext()) {</span>
<span class="fc" id="L434">                String groupName = groupIter.next();</span>
<span class="fc" id="L435">                stat.setString(1, dataobject.getId());</span>
                /*
				stat.setString(2, null);
				stat.setString(3, null);
				stat.setBigDecimal(4, null);
                 */
<span class="fc" id="L441">                stat.setString(2, null);</span>
<span class="fc" id="L442">                stat.setString(3, groupName);</span>
<span class="fc" id="L443">                stat.addBatch();</span>
<span class="fc" id="L444">                stat.clearParameters();</span>
<span class="fc" id="L445">            }</span>
<span class="nc" id="L446">        } catch (Throwable t) {</span>
<span class="nc" id="L447">            _logger.error(&quot;Error saving group relation record for dataobject {}&quot;, dataobject.getId(), t);</span>
<span class="nc" id="L448">            throw new RuntimeException(&quot;Error saving group relation record for dataobject &quot; + dataobject.getId(), t);</span>
<span class="fc" id="L449">        }</span>
<span class="fc" id="L450">    }</span>

    /**
     * Add a record in the table 'dataobjectrelations' for every resource, page, other dataobject, role and category
     * associated to the given dataobject).
     *
     * @param dataobject The current dataobject.
     * @param conn       The connection to the database.
     * @throws EntException when connection error are detected.
     */
    protected void addDataObjectRelationsRecord(DataObject dataobject, Connection conn) {
<span class="fc" id="L461">        PreparedStatement stat = null;</span>
        try {
<span class="fc" id="L463">            stat = conn.prepareStatement(ADD_DATAOBJECT_REL_RECORD);</span>
<span class="fc" id="L464">            this.addCategoryRelationsRecord(dataobject, true, stat);</span>
<span class="fc" id="L465">            this.addGroupRelationsRecord(dataobject, stat);</span>
<span class="fc" id="L466">            EntityAttributeIterator attributeIter = new EntityAttributeIterator(dataobject);</span>
<span class="fc bfc" id="L467" title="All 2 branches covered.">            while (attributeIter.hasNext()) {</span>
<span class="fc" id="L468">                AttributeInterface currAttribute = (AttributeInterface) attributeIter.next();</span>
<span class="fc" id="L469">            }</span>
<span class="fc" id="L470">            stat.executeBatch();</span>
<span class="nc" id="L471">        } catch (BatchUpdateException e) {</span>
<span class="nc" id="L472">            _logger.error(&quot;Error saving record into dataobjectrelations {}&quot;, dataobject.getId(), e.getNextException());</span>
<span class="nc" id="L473">            throw new RuntimeException(&quot;Error saving record into dataobjectrelations &quot; + dataobject.getId(), e.getNextException());</span>
<span class="nc" id="L474">        } catch (Throwable t) {</span>
<span class="nc" id="L475">            _logger.error(&quot;Error saving record into dataobjectrelations {}&quot;, dataobject.getId(), t);</span>
<span class="nc" id="L476">            throw new RuntimeException(&quot;Error saving record into dataobjectrelations &quot; + dataobject.getId(), t);</span>
        } finally {
<span class="fc" id="L478">            closeDaoResources(null, stat);</span>
        }
<span class="fc" id="L480">    }</span>

    protected void addDataObjectAttributeRoleRecord(String id, IApsEntity entity, String query, Connection conn) {
<span class="fc" id="L483">        PreparedStatement stat = null;</span>
        try {
<span class="fc" id="L485">            stat = conn.prepareStatement(query);</span>
<span class="fc" id="L486">            super.addEntityAttributeRoleRecord(id, entity, stat);</span>
<span class="nc" id="L487">        } catch (Throwable t) {</span>
<span class="nc" id="L488">            _logger.error(&quot;Error on adding dataobject attribute role records&quot;, t);</span>
<span class="nc" id="L489">            throw new RuntimeException(&quot;Error on adding dataobject attribute role records&quot;, t);</span>
        } finally {
<span class="fc" id="L491">            closeDaoResources(null, stat);</span>
        }
<span class="fc" id="L493">    }</span>

    protected List&lt;String&gt; getUtilizers(String referencedObjectCode, String query) throws Throwable {
<span class="fc" id="L496">        Connection conn = null;</span>
<span class="fc" id="L497">        List&lt;String&gt; dataids = new ArrayList&lt;String&gt;();</span>
<span class="fc" id="L498">        PreparedStatement stat = null;</span>
<span class="fc" id="L499">        ResultSet res = null;</span>
        try {
<span class="fc" id="L501">            conn = this.getConnection();</span>
<span class="fc" id="L502">            stat = conn.prepareStatement(query);</span>
<span class="fc" id="L503">            stat.setString(1, referencedObjectCode);</span>
<span class="fc" id="L504">            res = stat.executeQuery();</span>
<span class="fc bfc" id="L505" title="All 2 branches covered.">            while (res.next()) {</span>
<span class="fc" id="L506">                String id = res.getString(1);</span>
<span class="fc" id="L507">                dataids.add(id);</span>
<span class="fc" id="L508">            }</span>
<span class="nc" id="L509">        } catch (Throwable t) {</span>
<span class="nc" id="L510">            throw t;</span>
        } finally {
<span class="fc" id="L512">            closeDaoResources(res, stat, conn);</span>
        }
<span class="fc" id="L514">        return dataids;</span>
    }

    @Override
    public DataObjectsStatus loadDataObjectsStatus() {
<span class="nc" id="L519">        Connection conn = null;</span>
<span class="nc" id="L520">        PreparedStatement stat = null;</span>
<span class="nc" id="L521">        ResultSet res = null;</span>
<span class="nc" id="L522">        DataObjectsStatus status = null;</span>
        try {
<span class="nc" id="L524">            conn = this.getConnection();</span>
<span class="nc" id="L525">            int online = this.loadDataObjectStatus(conn, COUNT_DATAOBJECTS);</span>
<span class="nc" id="L526">            int offline = this.loadDataObjectStatus(conn, COUNT_OFFLINE_DATAOBJECTS);</span>
<span class="nc" id="L527">            int withDiffs = this.loadDataObjectStatus(conn, COUNT_DATAOBJECTS_WITH_DIFFS);</span>
<span class="nc" id="L528">            Date lastModified = this.loadDataObjectStatusLastModified(conn, LOAD_LAST_MODIFIED);</span>
<span class="nc" id="L529">            status = new DataObjectsStatus();</span>
<span class="nc" id="L530">            status.setDraft(offline);</span>
<span class="nc" id="L531">            status.setOnline(online);</span>
<span class="nc" id="L532">            status.setOnlineWithChanges(withDiffs);</span>
<span class="nc" id="L533">            status.setLastUpdate(lastModified);</span>
<span class="nc" id="L534">        } catch (Throwable t) {</span>
<span class="nc" id="L535">            _logger.error(&quot;Error loading dataobjects status&quot;, t);</span>
<span class="nc" id="L536">            throw new RuntimeException(&quot;Error loading dataobjects status&quot;, t);</span>
        } finally {
<span class="nc" id="L538">            closeDaoResources(res, stat, conn);</span>
        }
<span class="nc" id="L540">        return status;</span>
    }

    private int loadDataObjectStatus(Connection conn, String query) {
<span class="nc" id="L544">        PreparedStatement stat = null;</span>
<span class="nc" id="L545">        ResultSet res = null;</span>
<span class="nc" id="L546">        int count = 0;</span>
        try {
<span class="nc" id="L548">            stat = conn.prepareStatement(query);</span>
<span class="nc" id="L549">            res = stat.executeQuery();</span>
<span class="nc bnc" id="L550" title="All 2 branches missed.">            if (res.next()) {</span>
<span class="nc" id="L551">                count = res.getInt(1);</span>
            }
<span class="nc" id="L553">        } catch (Throwable t) {</span>
<span class="nc" id="L554">            _logger.error(&quot;Error loading dataobjects status. If you are runing Entando backed by Apache Derby it's a known issue&quot;);</span>
        } finally {
<span class="nc" id="L556">            closeDaoResources(res, stat);</span>
        }
<span class="nc" id="L558">        return count;</span>
    }

    private Date loadDataObjectStatusLastModified(Connection conn, String query) {
<span class="nc" id="L562">        PreparedStatement stat = null;</span>
<span class="nc" id="L563">        ResultSet res = null;</span>
<span class="nc" id="L564">        Date lastModified = null;</span>
        try {
<span class="nc" id="L566">            stat = conn.prepareStatement(query);</span>
<span class="nc" id="L567">            res = stat.executeQuery();</span>
<span class="nc bnc" id="L568" title="All 2 branches missed.">            if (res.next()) {</span>
<span class="nc" id="L569">                String lastMod = res.getString(&quot;lastmodified&quot;);</span>
<span class="nc" id="L570">                lastModified = DateConverter.parseDate(lastMod, &quot;yyyyMMddHHmmss&quot;);</span>
            }
<span class="nc" id="L572">        } catch (Throwable t) {</span>
<span class="nc" id="L573">            _logger.error(&quot;Error loading dataobjects status last modified date&quot;, t);</span>
<span class="nc" id="L574">            throw new RuntimeException(&quot;Error loading dataobjects status last modified date&quot;, t);</span>
        } finally {
<span class="nc" id="L576">            closeDaoResources(res, stat);</span>
        }
<span class="nc" id="L578">        return lastModified;</span>
    }

    @Override
    protected String getAddingSearchRecordQuery() {
<span class="fc" id="L583">        return ADD_DATAOBJECT_SEARCH_RECORD;</span>
    }

    @Override
    protected String getRemovingSearchRecordQuery() {
<span class="fc" id="L588">        return DELETE_DATAOBJECT_SEARCH_RECORD;</span>
    }

    @Override
    protected String getAddingAttributeRoleRecordQuery() {
<span class="fc" id="L593">        return ADD_ATTRIBUTE_ROLE_RECORD;</span>
    }

    @Override
    protected String getRemovingAttributeRoleRecordQuery() {
<span class="fc" id="L598">        return DELETE_ATTRIBUTE_ROLE_RECORD;</span>
    }

    @Override
    protected String getExtractingAllEntityIdQuery() {
<span class="fc" id="L603">        return LOAD_ALL_DATAOBJECTS_ID;</span>
    }

<span class="fc" id="L606">    private final String DELETE_DATAOBJECT = &quot;DELETE FROM dataobjects WHERE dataid = ? &quot;;</span>

<span class="fc" id="L608">    private final String DELETE_DATAOBJECT_REL_RECORD = &quot;DELETE FROM dataobjectrelations WHERE dataid = ? &quot;;</span>

<span class="fc" id="L610">    private final String ADD_DATAOBJECT_SEARCH_RECORD = &quot;INSERT INTO dataobjectsearch (dataid, attrname, textvalue, datevalue, numvalue, langcode) &quot;</span>
            + &quot;VALUES ( ? , ? , ? , ? , ? , ? )&quot;;

<span class="fc" id="L613">    private final String DELETE_DATAOBJECT_SEARCH_RECORD = &quot;DELETE FROM dataobjectsearch WHERE dataid = ? &quot;;</span>

<span class="fc" id="L615">    private final String ADD_DATAOBJECT_REL_RECORD = &quot;INSERT INTO dataobjectrelations &quot;</span>
            + &quot;(dataid, refcategory, refgroup) VALUES ( ? , ? , ? )&quot;;

<span class="fc" id="L618">    private final String LOAD_DATAOBJECTS_ID_MAIN_BLOCK = &quot;SELECT DISTINCT dataobjects.dataid FROM dataobjects &quot;;</span>

<span class="fc" id="L620">    private final String LOAD_REFERENCED_DATAOBJECTS_FOR_GROUP = LOAD_DATAOBJECTS_ID_MAIN_BLOCK</span>
            + &quot; RIGHT JOIN dataobjectrelations ON dataobjects.dataid = dataobjectrelations.dataid WHERE dataobjectrelations.refgroup = ? &quot;
            + &quot;ORDER BY dataobjects.dataid&quot;;

<span class="fc" id="L624">    private final String LOAD_REFERENCED_DATAOBJECTS_FOR_CATEGORY = LOAD_DATAOBJECTS_ID_MAIN_BLOCK</span>
            + &quot; RIGHT JOIN dataobjectrelations ON dataobjects.dataid = dataobjectrelations.dataid WHERE dataobjectrelations.refcategory = ? &quot;
            + &quot;ORDER BY dataobjects.dataid&quot;;

<span class="fc" id="L628">    private final String LOAD_DATAOBJECTS_VO_MAIN_BLOCK = &quot;SELECT dataobjects.dataid, dataobjects.datatype, dataobjects.descr, dataobjects.status, &quot;</span>
            + &quot;dataobjects.workxml, dataobjects.created, dataobjects.lastmodified, dataobjects.onlinexml, dataobjects.maingroup, &quot;
            + &quot;dataobjects.currentversion, dataobjects.firsteditor, dataobjects.lasteditor FROM dataobjects &quot;;

<span class="fc" id="L632">    private final String LOAD_DATAOBJECT_VO = LOAD_DATAOBJECTS_VO_MAIN_BLOCK + &quot; WHERE dataobjects.dataid = ? &quot;;</span>

<span class="fc" id="L634">    private final String ADD_DATAOBJECT = &quot;INSERT INTO dataobjects (dataid, datatype, descr, status, workxml, &quot;</span>
            + &quot;created, lastmodified, onlinexml, maingroup, currentversion, firsteditor, lasteditor) &quot;
            + &quot;VALUES ( ? , ? , ? , ? , ? , ? , ? , ? , ? , ? , ?, ?)&quot;;

<span class="fc" id="L638">    private final String INSERT_DATAOBJECT = &quot;UPDATE dataobjects SET datatype = ? , descr = ? , status = ? , &quot;</span>
            + &quot;workxml = ? , lastmodified = ? , onlinexml = ? , maingroup = ? , currentversion = ? , lasteditor = ? &quot;
            + &quot;WHERE dataid = ? &quot;;

<span class="fc" id="L642">    private final String INSERT_DATAOBJECT_WITHOUT_DATE = &quot;UPDATE dataobjects SET datatype = ? , descr = ? , status = ? , &quot;</span>
            + &quot;workxml = ? , onlinexml = ? , maingroup = ? , currentversion = ? , lasteditor = ? &quot; + &quot;WHERE dataid = ? &quot;;

<span class="fc" id="L645">    private final String REMOVE_DATAOBJECT = &quot;UPDATE dataobjects SET onlinexml = ? , status = ? , &quot;</span>
            + &quot;workxml = ? , lastmodified = ? , currentversion = ? , lasteditor = ? WHERE dataid = ? &quot;;

<span class="fc" id="L648">    private final String REMOVE_DATAOBJECT_WITHOUT_DATE = &quot;UPDATE dataobjects SET onlinexml = ? , status = ? , &quot;</span>
            + &quot;workxml = ? , currentversion = ? , lasteditor = ? WHERE dataid = ? &quot;;

<span class="fc" id="L651">    private final String UPDATE_DATAOBJECT = &quot;UPDATE dataobjects SET datatype = ? , descr = ? , status = ? , &quot;</span>
            + &quot;workxml = ? , lastmodified = ? , maingroup = ? , currentversion = ? , lasteditor = ? &quot; + &quot;WHERE dataid = ? &quot;;

<span class="fc" id="L654">    private final String UPDATE_DATAOBJECT_WITHOUT_DATE = &quot;UPDATE dataobjects SET datatype = ? , descr = ? , status = ? , &quot;</span>
            + &quot;workxml = ? , maingroup = ? , currentversion = ? , lasteditor = ? &quot; + &quot;WHERE dataid = ? &quot;;

<span class="fc" id="L657">    private final String LOAD_ALL_DATAOBJECTS_ID = &quot;SELECT dataid FROM dataobjects&quot;;</span>

<span class="fc" id="L659">    private final String ADD_ATTRIBUTE_ROLE_RECORD = &quot;INSERT INTO dataobjectattributeroles (dataid, attrname, rolename) VALUES ( ? , ? , ? )&quot;;</span>

<span class="fc" id="L661">    private final String DELETE_ATTRIBUTE_ROLE_RECORD = &quot;DELETE FROM dataobjectattributeroles WHERE dataid = ? &quot;;</span>

    private static final String COUNT_OFFLINE_DATAOBJECTS = &quot;SELECT count(dataid) FROM dataobjects WHERE onlinexml IS NULL&quot;;

    private static final String COUNT_DATAOBJECTS = &quot;SELECT count(dataid) FROM dataobjects &quot;
            + &quot;WHERE onlinexml IS NOT NULL AND onlinexml = workxml&quot;;

    private static final String COUNT_DATAOBJECTS_WITH_DIFFS = &quot;SELECT count(dataid) FROM dataobjects &quot;
            + &quot;WHERE onlinexml IS NOT NULL AND onlinexml &lt;&gt; workxml&quot;;

<span class="fc" id="L671">    private final String LOAD_LAST_MODIFIED = LOAD_DATAOBJECTS_VO_MAIN_BLOCK + &quot;order by dataobjects.lastmodified desc&quot;;</span>

    @Override
    public List&lt;String&gt; getGroupUtilizers(String groupName) {
<span class="fc" id="L675">        List&lt;String&gt; dataids = null;</span>
        try {
<span class="fc" id="L677">            dataids = this.getUtilizers(groupName, LOAD_REFERENCED_DATAOBJECTS_FOR_GROUP);</span>
<span class="nc" id="L678">        } catch (Throwable t) {</span>
<span class="nc" id="L679">            _logger.error(&quot;Error loading referenced datatypes for group {}&quot;, groupName, t);</span>
<span class="nc" id="L680">            throw new RuntimeException(&quot;Error loading referenced datatypes for group &quot; + groupName, t);</span>
<span class="fc" id="L681">        }</span>
<span class="fc" id="L682">        return dataids;</span>
    }

    @Override
    public List&lt;String&gt; getCategoryUtilizers(String categoryCode) {
<span class="fc" id="L687">        List&lt;String&gt; dataids = null;</span>
        try {
<span class="fc" id="L689">            dataids = this.getUtilizers(categoryCode, LOAD_REFERENCED_DATAOBJECTS_FOR_CATEGORY);</span>
<span class="nc" id="L690">        } catch (Throwable t) {</span>
<span class="nc" id="L691">            _logger.error(&quot;Error loading referenced datatypes for category {}&quot;, categoryCode, t);</span>
<span class="nc" id="L692">            throw new RuntimeException(&quot;Error loading referenced datatypes for category &quot; + categoryCode, t);</span>
<span class="fc" id="L693">        }</span>
<span class="fc" id="L694">        return dataids;</span>
    }

    public ICategoryManager getCategoryManager() {
<span class="fc" id="L698">        return categoryManager;</span>
    }

    public void setCategoryManager(ICategoryManager categoryManager) {
<span class="fc" id="L702">        this.categoryManager = categoryManager;</span>
<span class="fc" id="L703">    }</span>
    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>